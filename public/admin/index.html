<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChemAI | Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --accent: #38bdf8;
            --accent-glass: rgba(56, 189, 248, 0.2);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #f8fafc;
            background-image:
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.1) 0px, transparent 50%);
            min-height: 100vh;
        }

        .glass {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-item-active {
            background: var(--accent-glass);
            border-left: 4px solid var(--accent);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="flex flex-col lg:flex-row h-screen overflow-hidden">
    <!-- Login Modal -->
    <div id="login-modal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="glass p-8 rounded-2xl w-full max-w-md animate-fade-in text-slate-200">
            <h2 class="text-2xl font-bold mb-6 text-center text-white">ChemAI Admin GiriÅŸi</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">E-posta</label>
                    <input type="email" id="login-email"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-sky-500"
                        placeholder="admin@chemai.com">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Åžifre</label>
                    <input type="password" id="login-password"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-sky-500"
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button id="login-btn" onclick="handleLogin()"
                    class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 rounded-lg transition-all shadow-lg shadow-sky-500/20 active:scale-[0.98]">
                    GiriÅŸ Yap
                </button>
                <p id="login-error" class="text-xs text-red-400 text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-full lg:w-64 glass border-r border-white/5 flex flex-col">
        <div class="p-6">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center shadow-lg shadow-sky-500/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-flask-conical">
                        <path d="M10 2v7.5" />
                        <path d="M14 2v7.5" />
                        <path d="M8.5 2h7" />
                        <path
                            d="M14 11.5c1.62-.3 2.5-1.5 2.5-1.5av10c0 4.42-3.58 8-8 8s-8-3.58-8-8c0 0 .88 1.2 2.5 1.5l1.5 7.5h8l1.5-7.5Z" />
                        <path d="M9 11v.01" />
                        <path d="M15 11v.01" />
                        <path d="M12 11v.01" />
                        <path d="m8 14 1 1" />
                        <path d="m11 14 1 1" />
                        <path d="m14 14 1 1" />
                    </svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight">ChemAI <span class="text-sky-400">Admin</span></h1>
            </div>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-2">
            <button onclick="showPage('stats')" id="nav-stats"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-white/5 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="18" height="18" x="3" y="3" rx="2" />
                    <path d="M7 16v-4" />
                    <path d="M11 16V8" />
                    <path d="M15 16v-2" />
                </svg>
                Ä°statistikler
            </button>
            <button onclick="showPage('users')" id="nav-users"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-white/5 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg>
                KullanÄ±cÄ±lar
            </button>
            <button onclick="showPage('logs')" id="nav-logs"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-white/5 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9" />
                    <polyline points="13 2 13 9 20 9" />
                </svg>
                Sistem LoglarÄ±
            </button>
            <button onclick="showPage('notifications')" id="nav-notifications"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-white/5 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" />
                    <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" />
                </svg>
                Bildirim GÃ¶nder
            </button>
        </nav>

        <div class="p-6 mt-auto">
            <button onclick="logout()"
                class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 hover:bg-red-500/10 text-slate-400 hover:text-red-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" x2="9" y1="12" y2="12" />
                </svg>
                Ã‡Ä±kÄ±ÅŸ Yap
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-4 lg:p-8 custom-scrollbar">
        <!-- Stats Page -->
        <section id="page-stats" class="space-y-8">
            <div class="flex flex-col gap-2">
                <h2 class="text-3xl font-bold">Genel BakÄ±ÅŸ</h2>
                <p class="text-slate-400">Sistem performansÄ± ve kullanÄ±cÄ± aktiviteleri hakkÄ±nda Ã¶zet bilgiler.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-sky-500/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="#38bdf8" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </div>
                    </div>
                    <div class="text-3xl font-bold" id="stat-users">0</div>
                    <div class="text-slate-400 text-sm">Toplam KullanÄ±cÄ±</div>
                </div>
                <div class="glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-emerald-500/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9" />
                                <polyline points="13 2 13 9 20 9" />
                            </svg>
                        </div>
                    </div>
                    <div class="text-3xl font-bold" id="stat-logs">0</div>
                    <div class="text-slate-400 text-sm">Toplam Ä°stek</div>
                </div>
                <div class="glass p-6 rounded-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-purple-500/10 rounded-xl">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="#a855f7" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                            </svg>
                        </div>
                    </div>
                    <div class="text-3xl font-bold" id="stat-chats">0</div>
                    <div class="text-slate-400 text-sm">Toplam Chat MesajÄ±</div>
                </div>
            </div>
        </section>

        <!-- Users Page -->
        <section id="page-users" class="hidden space-y-6">
            <h2 class="text-2xl font-bold">KullanÄ±cÄ± Listesi</h2>
            <div class="glass rounded-2xl overflow-hidden overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-slate-400 text-sm uppercase">
                        <tr>
                            <th class="px-6 py-4">AD SOYAD</th>
                            <th class="px-6 py-4">ID</th>
                            <th class="px-6 py-4">DURUM</th>
                            <th class="px-6 py-4">ADMIN</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="divide-y divide-white/5">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Logs Page -->
        <section id="page-logs" class="hidden space-y-6">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold">Sistem LoglarÄ±</h2>
                <button onclick="loadLogs()"
                    class="bg-sky-500/10 text-sky-400 px-4 py-2 rounded-lg hover:bg-sky-500/20 transition-all">Yenile</button>
            </div>
            <div class="glass rounded-2xl overflow-hidden overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white/5 text-slate-400 uppercase text-xs">
                        <tr>
                            <th class="px-6 py-4">ZAMAN</th>
                            <th class="px-6 py-4">KULLANICI</th>
                            <th class="px-6 py-4">METHOD</th>
                            <th class="px-6 py-4">PATH</th>
                            <th class="px-6 py-4">DURUM</th>
                            <th class="px-6 py-4">MS</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body" class="divide-y divide-white/5">
                        <!-- Logs will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Notifications Page -->
        <section id="page-notifications" class="hidden space-y-6">
            <div class="flex flex-col gap-2">
                <h2 class="text-3xl font-bold">ðŸ“¢ Bildirim GÃ¶nder</h2>
                <p class="text-slate-400">KullanÄ±cÄ±lara Firebase Push Notification gÃ¶nderin</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left: User Selection -->
                <div class="glass p-6 rounded-2xl space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold">KullanÄ±cÄ± SeÃ§imi</h3>
                        <div class="flex gap-2">
                            <button onclick="selectAllUsers()"
                                class="text-xs bg-sky-500/10 text-sky-400 px-3 py-1.5 rounded-lg hover:bg-sky-500/20 transition-all">
                                TÃ¼mÃ¼nÃ¼ SeÃ§
                            </button>
                            <button onclick="deselectAllUsers()"
                                class="text-xs bg-slate-500/10 text-slate-400 px-3 py-1.5 rounded-lg hover:bg-slate-500/20 transition-all">
                                Temizle
                            </button>
                        </div>
                    </div>

                    <div class="relative">
                        <input type="text" id="user-search" placeholder="KullanÄ±cÄ± ara..." onkeyup="filterUsers()"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:border-sky-500 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="absolute left-3 top-3 text-slate-500">
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.3-4.3" />
                        </svg>
                    </div>

                    <div id="users-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Users will be loaded here -->
                    </div>

                    <div class="pt-4 border-t border-white/10">
                        <p class="text-sm text-slate-400">
                            SeÃ§ili: <span id="selected-count" class="text-sky-400 font-bold">0</span> kullanÄ±cÄ±
                        </p>
                    </div>
                </div>

                <!-- Right: Notification Form -->
                <div class="space-y-6">
                    <div class="glass p-6 rounded-2xl space-y-4">
                        <h3 class="text-lg font-bold">Bildirim Ä°Ã§eriÄŸi</h3>

                        <div>
                            <label class="block text-sm font-medium mb-2">BaÅŸlÄ±k</label>
                            <input type="text" id="notif-title" placeholder="Bildirim baÅŸlÄ±ÄŸÄ±..."
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-sky-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Mesaj</label>
                            <textarea id="notif-body" rows="4" placeholder="Bildirim mesajÄ±..."
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-sky-500 resize-none"></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Ekstra Veri (JSON - Opsiyonel)</label>
                            <textarea id="notif-data" rows="3" placeholder='{"key": "value"}'
                                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:border-sky-500 resize-none font-mono text-xs"></textarea>
                            <p class="text-xs text-slate-500 mt-1">JSON formatÄ±nda ekstra veri ekleyebilirsiniz</p>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="glass p-6 rounded-2xl space-y-4">
                        <h3 class="text-lg font-bold">Ã–nizleme</h3>
                        <div class="bg-slate-900 rounded-xl p-4 border border-slate-700">
                            <div class="flex items-start gap-3">
                                <div
                                    class="w-8 h-8 bg-sky-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M10 2v7.5M14 2v7.5M8.5 2h7M14 11.5c1.62-.3 2.5-1.5 2.5-1.5av10c0 4.42-3.58 8-8 8s-8-3.58-8-8c0 0 .88 1.2 2.5 1.5l1.5 7.5h8l1.5-7.5Z" />
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p id="preview-title" class="font-bold text-white truncate">Bildirim BaÅŸlÄ±ÄŸÄ±</p>
                                    <p id="preview-body" class="text-sm text-slate-400 mt-1 line-clamp-2">Bildirim
                                        mesajÄ±
                                        burada gÃ¶rÃ¼necek</p>
                                    <p class="text-xs text-slate-500 mt-2">Åžimdi</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Send Button -->
                    <button id="send-notif-btn" onclick="sendNotifications()"
                        class="w-full bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-sky-500/20 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m3 3 3 9-3 9 19-9Z" />
                                <path d="M6 12h16" />
                            </svg>
                            Bildirim GÃ¶nder
                        </span>
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script>
        let supabaseClient;
        let currentToken = localStorage.getItem('admin_token');
        let currentPage = 'stats';

        async function init() {
            const configRes = await fetch('/api/config');
            const config = await configRes.json();
            supabaseClient = supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);

            if (!currentToken) {
                document.getElementById('login-modal').classList.remove('hidden');
            } else {
                showPage('stats');
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('login-error');

            btn.disabled = true;
            btn.innerText = 'GiriÅŸ YapÄ±lÄ±yor...';
            err.classList.add('hidden');

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                err.innerText = error.message;
                err.classList.remove('hidden');
                btn.disabled = false;
                btn.innerText = 'GiriÅŸ Yap';
                return;
            }

            // Check if user is admin
            const { data: profile } = await supabaseClient
                .from('profiles')
                .select('is_admin')
                .eq('id', data.user.id)
                .single();

            if (!profile?.is_admin) {
                err.innerText = 'YÃ¶netici yetkiniz bulunmuyor!';
                err.classList.remove('hidden');
                await supabaseClient.auth.signOut();
                btn.disabled = false;
                btn.innerText = 'GiriÅŸ Yap';
                return;
            }

            currentToken = data.session.access_token;
            localStorage.setItem('admin_token', currentToken);
            document.getElementById('login-modal').classList.add('hidden');
            showPage('stats');
        }

        async function showPage(page) {
            currentPage = page;
            ['stats', 'users', 'logs', 'notifications'].forEach(p => {
                const el = document.getElementById(`page-${p}`);
                const nav = document.getElementById(`nav-${p}`);
                if (el) el.classList.add('hidden');
                if (nav) nav.classList.remove('sidebar-item-active');
            });
            document.getElementById(`page-${page}`).classList.remove('hidden');
            document.getElementById(`nav-${page}`).classList.add('sidebar-item-active');

            if (page === 'stats') loadStats();
            if (page === 'users') loadUsers();
            if (page === 'logs') loadLogs();
            if (page === 'notifications') loadUsersForNotifications();
        }

        async function apiFetch(endpoint) {
            if (!currentToken) {
                document.getElementById('login-modal').classList.remove('hidden');
                return null;
            }
            try {
                const res = await fetch(`/api${endpoint}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                if (res.status === 401 || res.status === 403) {
                    logout();
                    return null;
                }
                return await res.json();
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        function logout() {
            localStorage.removeItem('admin_token');
            currentToken = null;
            if (supabaseClient) supabaseClient.auth.signOut();
            location.reload();
        }

        async function loadStats() {
            const data = await apiFetch('/admin/stats');
            if (data) {
                document.getElementById('stat-users').innerText = data.totalUsers || 0;
                document.getElementById('stat-logs').innerText = data.totalLogs || 0;
                document.getElementById('stat-chats').innerText = data.totalChats || 0;
            }
        }

        async function loadUsers() {
            const data = await apiFetch('/admin/users');
            if (data) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = data.map(u => `
                    <tr class="hover:bg-white/5 transition-colors">
                        <td class="px-6 py-4 font-medium">${u.first_name || ''} ${u.last_name || ''}</td>
                        <td class="px-6 py-4 text-slate-500 text-xs">${u.id}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 bg-emerald-500/10 text-emerald-400 rounded-lg text-xs">Aktif</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="${u.is_admin ? 'text-sky-400 font-bold' : 'text-slate-500'}">${u.is_admin ? 'EVET' : 'HAYIR'}</span>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadLogs() {
            const data = await apiFetch('/admin/logs');
            if (data) {
                const tbody = document.getElementById('logs-table-body');
                tbody.innerHTML = data.map(l => `
                    <tr class="hover:bg-white/5 transition-colors cursor-pointer group" onclick="showLogDetails(${JSON.stringify(l).replace(/"/g, '&quot;')})">
                        <td class="px-6 py-4 text-slate-400 text-xs">${new Date(l.created_at).toLocaleString()}</td>
                        <td class="px-6 py-4 font-medium text-slate-200">
                            ${l.profiles ? (l.profiles.first_name + ' ' + (l.profiles.last_name || '')) : '<span class="text-slate-600">Misafir</span>'}
                        </td>
                        <td class="px-6 py-4"><span class="px-2 py-1 ${getMethodColor(l.method)} rounded-lg text-[10px] font-bold">${l.method}</span></td>
                        <td class="px-6 py-4 text-xs font-mono group-hover:text-sky-400 transition-colors">${l.path}</td>
                        <td class="px-6 py-4">
                            <span class="font-bold ${l.status_code >= 400 ? 'text-red-400' : 'text-emerald-400'}">${l.status_code}</span>
                        </td>
                        <td class="px-6 py-4 text-slate-500 text-xs">${l.duration_ms}ms</td>
                    </tr>
                `).join('');
            }
        }

        function showLogDetails(log) {
            // Create or show a detailed modal
            let modal = document.getElementById('details-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'details-modal';
                modal.className = 'fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-4';
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
                <div class="glass p-8 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto custom-scrollbar relative">
                    <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
                    </button>
                    <h3 class="text-2xl font-bold mb-6">Ä°stek DetayÄ±</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-slate-500 font-bold uppercase">KullanÄ±cÄ±</label>
                                <p class="text-slate-200">${log.profiles ? (log.profiles.first_name + ' ' + (log.profiles.last_name || '')) : 'Anonim'}</p>
                                <p class="text-xs text-slate-500 font-mono">${log.user_id || '-'}</p>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 font-bold uppercase">Endpoint</label>
                                <p class="font-mono text-sky-400">${log.method} ${log.path}</p>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 font-bold uppercase">Meta Veriler</label>
                                <div class="text-xs text-slate-400 space-y-1 mt-2">
                                    <p>Durum: <span class="${log.status_code >= 400 ? 'text-red-400' : 'text-emerald-400'}">${log.status_code}</span></p>
                                    <p>SÃ¼re: ${log.duration_ms}ms</p>
                                    <p>Zaman: ${new Date(log.created_at).toLocaleString()}</p>
                                    <p>IP: ${log.ip || 'Bilinmiyor'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-slate-500 font-bold uppercase">Request Body</label>
                                <pre class="mt-2 bg-black/40 p-4 rounded-xl text-xs overflow-x-auto text-emerald-400 font-mono custom-scrollbar">${JSON.stringify(log.body, null, 2) || '{}'}</pre>
                            </div>
                            <div>
                                <label class="text-xs text-slate-500 font-bold uppercase">Query Params</label>
                                <pre class="mt-2 bg-black/40 p-4 rounded-xl text-xs overflow-x-auto text-sky-400 font-mono custom-scrollbar">${JSON.stringify(log.query_params, null, 2) || '{}'}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function getMethodColor(method) {
            switch (method) {
                case 'GET': return 'bg-sky-500/10 text-sky-400';
                case 'POST': return 'bg-emerald-500/10 text-emerald-400';
                case 'PUT': return 'bg-amber-500/10 text-amber-400';
                case 'DELETE': return 'bg-red-500/10 text-red-400';
                default: return 'bg-slate-500/10 text-slate-400';
            }
        }

        // Notification Page Functions
        let allUsers = [];
        let selectedUserIds = new Set();

        async function loadUsersForNotifications() {
            const data = await apiFetch('/admin/users');
            if (data) {
                allUsers = data;
                renderUsersList();
                updatePreview();
            }
        }

        function renderUsersList() {
            const container = document.getElementById('users-list');
            const searchTerm = document.getElementById('user-search')?.value.toLowerCase() || '';

            const filteredUsers = allUsers.filter(u => {
                const fullName = `${u.first_name || ''} ${u.last_name || ''}`.toLowerCase();
                const email = (u.email || '').toLowerCase();
                return fullName.includes(searchTerm) || email.includes(searchTerm);
            });

            container.innerHTML = filteredUsers.map(u => {
                const isSelected = selectedUserIds.has(u.id);
                const fullName = `${u.first_name || ''} ${u.last_name || ''}`.trim() || 'Ä°simsiz KullanÄ±cÄ±';

                return `
                    <label class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 cursor-pointer transition-all ${isSelected ? 'bg-sky-500/10 border border-sky-500/30' : 'border border-transparent'}">
                        <input type="checkbox" 
                            ${isSelected ? 'checked' : ''} 
                            onchange="toggleUser('${u.id}')"
                            class="w-4 h-4 rounded border-slate-600 text-sky-500 focus:ring-sky-500 focus:ring-offset-0 bg-slate-700">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium truncate">${fullName}</p>
                            ${u.email ? `<p class="text-xs text-slate-500 truncate">${u.email}</p>` : ''}
                        </div>
                        ${u.fcm_token ? '<span class="text-xs text-emerald-400">âœ“ FCM</span>' : '<span class="text-xs text-slate-600">No FCM</span>'}
                    </label>
                `;
            }).join('');

            updateSelectedCount();
        }

        function toggleUser(userId) {
            if (selectedUserIds.has(userId)) {
                selectedUserIds.delete(userId);
            } else {
                selectedUserIds.add(userId);
            }
            renderUsersList();
        }

        function selectAllUsers() {
            allUsers.forEach(u => selectedUserIds.add(u.id));
            renderUsersList();
        }

        function deselectAllUsers() {
            selectedUserIds.clear();
            renderUsersList();
        }

        function filterUsers() {
            renderUsersList();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedUserIds.size;
        }

        function updatePreview() {
            const title = document.getElementById('notif-title')?.value || 'Bildirim BaÅŸlÄ±ÄŸÄ±';
            const body = document.getElementById('notif-body')?.value || 'Bildirim mesajÄ± burada gÃ¶rÃ¼necek';

            document.getElementById('preview-title').textContent = title;
            document.getElementById('preview-body').textContent = body;
        }

        // Update preview on input
        if (document.getElementById('notif-title')) {
            document.getElementById('notif-title').addEventListener('input', updatePreview);
            document.getElementById('notif-body').addEventListener('input', updatePreview);
        }

        async function sendNotifications() {
            const title = document.getElementById('notif-title').value.trim();
            const body = document.getElementById('notif-body').value.trim();
            const dataInput = document.getElementById('notif-data').value.trim();
            const btn = document.getElementById('send-notif-btn');

            if (!title || !body) {
                alert('LÃ¼tfen baÅŸlÄ±k ve mesaj alanlarÄ±nÄ± doldurun!');
                return;
            }

            if (selectedUserIds.size === 0) {
                alert('LÃ¼tfen en az bir kullanÄ±cÄ± seÃ§in!');
                return;
            }

            let data = {};
            if (dataInput) {
                try {
                    data = JSON.parse(dataInput);
                } catch (e) {
                    alert('Ekstra veri geÃ§erli bir JSON formatÄ±nda deÄŸil!');
                    return;
                }
            }

            btn.disabled = true;
            btn.innerHTML = `
                <span class="flex items-center justify-center gap-2">
                    <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    </svg>
                    GÃ¶nderiliyor...
                </span>
            `;

            try {
                const response = await fetch('/api/notifications/send-to-multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        userIds: Array.from(selectedUserIds),
                        title,
                        body,
                        data
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Show success modal
                    showResultModal(true, result);

                    // Clear form
                    document.getElementById('notif-title').value = '';
                    document.getElementById('notif-body').value = '';
                    document.getElementById('notif-data').value = '';
                    deselectAllUsers();
                    updatePreview();
                } else {
                    showResultModal(false, result);
                }
            } catch (error) {
                showResultModal(false, { error: error.message });
            } finally {
                btn.disabled = false;
                btn.innerHTML = `
                    <span class="flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m3 3 3 9-3 9 19-9Z" />
                            <path d="M6 12h16" />
                        </svg>
                        Bildirim GÃ¶nder
                    </span>
                `;
            }
        }

        function showResultModal(success, result) {
            let modal = document.getElementById('result-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'result-modal';
                modal.className = 'fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md p-4';
                document.body.appendChild(modal);
            }

            const icon = success
                ? '<svg class="w-16 h-16 text-emerald-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                : '<svg class="w-16 h-16 text-red-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';

            modal.innerHTML = `
                <div class="glass p-8 rounded-2xl w-full max-w-md text-center animate-fade-in">
                    ${icon}
                    <h3 class="text-2xl font-bold mt-4 ${success ? 'text-emerald-400' : 'text-red-400'}">
                        ${success ? 'BaÅŸarÄ±lÄ±!' : 'Hata!'}
                    </h3>
                    <p class="text-slate-300 mt-2">
                        ${success
                    ? `${result.successCount} kullanÄ±cÄ±ya bildirim gÃ¶nderildi!`
                    : result.error || 'Bildirim gÃ¶nderilemedi'}
                    </p>
                    ${success && result.failureCount > 0 ? `<p class="text-amber-400 text-sm mt-2">${result.failureCount} kullanÄ±cÄ±ya gÃ¶nderilemedi</p>` : ''}
                    <button onclick="document.getElementById('result-modal').remove()" 
                        class="mt-6 px-6 py-2 bg-sky-500 hover:bg-sky-600 rounded-lg font-medium transition-all">
                        Tamam
                    </button>
                </div>
            `;

            setTimeout(() => {
                modal.remove();
            }, 5000);
        }

        init();
    </script>
</body>

</html>